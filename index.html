<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="è¯¾æ—¶ç®¡ç†">
<meta name="theme-color" content="#1a1a2e">
<meta name="description" content="ä¸€å¯¹ä¸€æ•™åŸ¹å­¦ç”Ÿè¯¾æ—¶è®°å½•ä¸ç»­è´¹æé†’">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
<title>è¯¾æ—¶ç®¡ç†</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
<style>
:root {
  --bg: #0f0f1a;
  --card: #1a1a2e;
  --card-alt: #1e1e35;
  --border: #2a2a45;
  --text: #e8e8f0;
  --text-dim: #8888a8;
  --accent: #7c6aff;
  --accent-soft: rgba(124,106,255,0.13);
  --warn: #ffb340;
  --warn-soft: rgba(255,179,64,0.10);
  --danger: #ff6b6b;
  --success: #4ecdc4;
  --success-soft: rgba(78,205,196,0.10);
  --safe-t: env(safe-area-inset-top, 20px);
  --safe-b: env(safe-area-inset-bottom, 0px);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html{background:var(--bg)}
body{
  font-family:'Noto Sans SC',-apple-system,'PingFang SC','Helvetica Neue',sans-serif;
  background:var(--bg);color:var(--text);
  min-height:100vh;min-height:100dvh;
  overflow-x:hidden;overscroll-behavior-y:contain;
}
body::before{
  content:'';position:fixed;inset:0;
  background:
    radial-gradient(ellipse at 20% 10%, rgba(124,106,255,0.05) 0%, transparent 60%),
    radial-gradient(ellipse at 80% 90%, rgba(78,205,196,0.03) 0%, transparent 60%);
  pointer-events:none;z-index:0;
}
.app{
  position:relative;z-index:1;
  max-width:480px;margin:0 auto;
  padding:calc(var(--safe-t) + 8px) 16px calc(var(--safe-b) + 88px);
}

/* ===== Header ===== */
.hdr{padding:4px 0 18px}
.hdr h1{
  font-size:24px;font-weight:700;letter-spacing:-0.5px;
  background:linear-gradient(135deg,#7c6aff 30%,#4ecdc4 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
}
.hdr-stats{display:flex;gap:14px;margin-top:10px;flex-wrap:wrap}
.chip{
  font-size:11px;color:var(--text-dim);
  display:flex;align-items:center;gap:4px;
}
.chip b{font-size:14px;color:var(--text);font-weight:700}
.chip.alert b{color:var(--warn)}

/* Sync Status */
.sync-status {
  position: fixed;
  top: calc(var(--safe-t) + 10px);
  right: 16px;
  z-index: 100;
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 20px;
  font-size: 11px;
  opacity: 0;
  transition: opacity 0.3s;
}
.sync-status.show {
  opacity: 1;
}
.sync-status.online {
  color: var(--success);
  border-color: var(--success);
}
.sync-status.offline {
  color: var(--danger);
  border-color: var(--danger);
}
.sync-status::before {
  content: '';
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: currentColor;
  animation: pulse 2s infinite;
}
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* ===== Tabs ===== */
.tabs{
  display:flex;gap:3px;
  background:var(--card);border-radius:13px;padding:3px;
  margin-bottom:14px;
}
.tab{
  flex:1;padding:9px 0;border:none;border-radius:11px;
  background:0;color:var(--text-dim);
  font:500 12.5px/1 inherit;cursor:pointer;transition:.2s;
  position:relative;
}
.tab.on{background:var(--accent);color:#fff;font-weight:600;box-shadow:0 2px 14px rgba(124,106,255,.35)}
.tab .bdg{
  font-size:10px;font-weight:700;
  background:rgba(255,179,64,.85);color:#1a1a2e;
  padding:1px 6px;border-radius:7px;margin-left:3px;
  vertical-align:1px;
}
.tab.on .bdg{background:rgba(255,255,255,.28);color:#fff}

/* ===== Search ===== */
.sbar{position:relative;margin-bottom:12px}
.sbar input{
  width:100%;padding:10px 14px 10px 34px;
  background:var(--card);border:1px solid var(--border);border-radius:12px;
  color:var(--text);font:14px/1.4 inherit;outline:0;
}
.sbar input:focus{border-color:var(--accent)}
.sbar i{position:absolute;left:11px;top:50%;transform:translateY(-50%);font-style:normal;font-size:14px;color:var(--text-dim)}

/* ===== Cards ===== */
.card{
  background:var(--card);border:1px solid var(--border);
  border-radius:16px;padding:15px 16px;margin-bottom:10px;
  cursor:pointer;position:relative;overflow:hidden;
  transition:border .2s;
}
.card.warn{border-color:rgba(255,179,64,.3)}
.card.warn::after{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg,var(--warn),#ff8c40);
}
.card-row{display:flex;justify-content:space-between;align-items:center}
.card-left{display:flex;align-items:center;gap:11px;flex:1;min-width:0}
.av{
  width:40px;height:40px;border-radius:12px;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;
  font-weight:700;font-size:16px;color:#fff;
}
.nm{font-weight:600;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.subj{
  font-size:10.5px;color:var(--accent);background:var(--accent-soft);
  padding:2px 7px;border-radius:6px;margin-left:5px;white-space:nowrap;
}
.rtag{font-size:10.5px;color:var(--warn);font-weight:600;display:flex;align-items:center;gap:2px}
.ct-info{font-size:11px;color:var(--text-dim);margin-top:3px;display:flex;gap:10px}
.cnt{text-align:right;flex-shrink:0;padding-left:10px}
.cnt .n{font-size:28px;font-weight:700;line-height:1;font-variant-numeric:tabular-nums}
.cnt .l{font-size:11px;color:var(--text-dim)}

/* Progress */
.prog{height:4px;background:var(--border);border-radius:4px;margin-top:11px;overflow:hidden}
.prog-fill{height:100%;border-radius:4px;transition:width .35s ease}

/* Expanded */
.acts{
  margin-top:13px;padding-top:13px;
  border-top:1px solid var(--border);
  display:flex;flex-wrap:wrap;gap:8px;align-items:center;
}
.btn{
  padding:9px 16px;border:none;border-radius:11px;
  font:600 12.5px/1 inherit;cursor:pointer;
  display:flex;align-items:center;gap:4px;
  transition:transform .1s;
}
.btn:active{transform:scale(.95)}
.btn-p{background:var(--accent);color:#fff}
.btn-w{background:var(--warn);color:#1a1a2e}
.btn-g{background:var(--accent-soft);color:var(--accent)}
.btn-d{background:0;color:var(--danger);border:1px solid rgba(255,107,107,.25);font-size:11.5px;font-weight:500}
.btn-sm{padding:8px 13px;font-size:11.5px}
.ml-auto{margin-left:auto}
.rhist{
  width:100%;margin-top:10px;padding:10px 12px;
  background:rgba(124,106,255,.05);border-radius:10px;
  font-size:12px;color:var(--text-dim);
}
.rhist strong{color:var(--text)}
.ritem{
  display:inline-block;background:var(--card);
  padding:3px 9px;border-radius:7px;margin:4px 4px 0 0;
  font-size:11px;border:1px solid var(--border);
}

/* ===== Renewal Log ===== */
.log-total{
  text-align:center;margin-bottom:14px;padding:14px;
  background:var(--success-soft);border-radius:14px;
}
.log-total .amt{font-size:24px;font-weight:700;color:var(--success)}
.log-total .lbl{font-size:12px;color:var(--text-dim)}
.log-card{
  background:var(--card);border:1px solid var(--border);
  border-radius:13px;padding:13px 15px;margin-bottom:8px;
}
.log-top{display:flex;justify-content:space-between;align-items:center}
.log-nm{font-weight:600;font-size:14px}
.log-dt{font-size:12px;color:var(--success)}
.log-det{font-size:12px;color:var(--text-dim);margin-top:5px}

/* ===== FAB ===== */
.fab{
  position:fixed;z-index:50;
  bottom:calc(var(--safe-b) + 24px);right:max(24px, calc(50% - 240px + 24px));
  width:54px;height:54px;border-radius:16px;
  background:linear-gradient(135deg,#7c6aff,#5a4fd4);
  border:none;color:#fff;font-size:26px;cursor:pointer;
  box-shadow:0 4px 20px rgba(124,106,255,.4);
  display:flex;align-items:center;justify-content:center;
  transition:transform .15s;
}
.fab:active{transform:scale(.88)}

/* ===== Settings gear ===== */
.gear{
  position:fixed;z-index:50;
  bottom:calc(var(--safe-b) + 24px);left:max(24px, calc(50% - 240px + 24px));
  width:44px;height:44px;border-radius:13px;
  background:var(--card);border:1px solid var(--border);
  color:var(--text-dim);font-size:20px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
}
.gear:active{transform:scale(.9)}

/* ===== Overlay / Modal ===== */
.ov{
  position:fixed;inset:0;background:rgba(0,0,0,.55);
  z-index:100;display:flex;align-items:flex-end;justify-content:center;
  animation:fi .18s;
}
.modal{
  background:var(--card);border-radius:20px 20px 0 0;
  padding:22px 20px calc(var(--safe-b) + 22px);
  width:100%;max-width:480px;animation:su .28s ease;
}
.modal h2{font-size:17px;margin-bottom:16px;font-weight:700}
.mx{float:right;background:0;border:0;color:var(--text-dim);font-size:22px;cursor:pointer;margin-top:-2px}
.fg{margin-bottom:12px}
.fl{font-size:11.5px;color:var(--text-dim);margin-bottom:5px;display:block;font-weight:500}
.fi{
  width:100%;padding:11px 13px;background:var(--bg);
  border:1px solid var(--border);border-radius:11px;
  color:var(--text);font:15px/1.3 inherit;outline:0;
}
.fi:focus{border-color:var(--accent)}
.fr{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.fs{
  width:100%;padding:13px;background:var(--accent);color:#fff;
  border:none;border-radius:13px;font:600 15px/1 inherit;
  cursor:pointer;margin-top:4px;
}
.fs:active{opacity:.85}

/* Confirm */
.cdlg{
  position:fixed;inset:0;background:rgba(0,0,0,.55);
  z-index:200;display:flex;align-items:center;justify-content:center;
  animation:fi .12s;
}
.cbox{
  background:var(--card);border-radius:20px;padding:26px 22px;
  width:88%;max-width:340px;text-align:center;
  border:1px solid var(--border);
}
.cbox h3{font-size:16px;margin-bottom:7px}
.cbox p{font-size:12.5px;color:var(--text-dim);margin-bottom:18px}
.cbtns{display:flex;gap:10px}
.cbtns .btn{flex:1;justify-content:center;padding:12px}

/* Settings panel */
.settings-list{display:flex;flex-direction:column;gap:10px}
.settings-item{
  display:flex;justify-content:space-between;align-items:center;
  padding:13px 15px;background:var(--bg);border-radius:12px;
  cursor:pointer;
}
.settings-item:active{opacity:.8}
.si-label{font-size:14px}
.si-hint{font-size:11px;color:var(--text-dim)}
.si-arrow{color:var(--text-dim);font-size:16px}

/* Empty */
.empty{text-align:center;padding:50px 20px;color:var(--text-dim)}
.empty-ico{font-size:44px;margin-bottom:10px}
.empty-txt{font-size:13px}

/* Animations */
@keyframes fi{from{opacity:0}to{opacity:1}}
@keyframes su{from{transform:translateY(100%)}to{transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.55}}
.pulse{animation:pulse 2s infinite}
</style>
</head>
<body>
<div class="app" id="app"></div>
<div class="sync-status" id="syncStatus"></div>

<script>
// ===== Data =====
const KEY='tutor_v3';
const SUPABASE_URL='https://jfwcisseawzpiaodrboi.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impmd2Npc3NlYXd6cGlhb2RyYm9pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NjQyOTgsImV4cCI6MjA4NjA0MDI5OH0.5tm1LT1WLMtCCHaFGj02W5jd2GXW_7QYXzl-sjVFqcQ';
const COLORS=['#7c6aff','#4ecdc4','#ff6b6b','#ffb340','#45b7d1','#f78fb3','#6c5ce7','#00b894','#e17055','#636e72'];

// Initialize Supabase
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Local storage functions
function load(){try{const r=localStorage.getItem(KEY);return r?JSON.parse(r):{students:[],log:[]}}catch{return{students:[],log:[]}}}
function save(d){localStorage.setItem(KEY,JSON.stringify(d))}
function generateId(){return crypto.randomUUID()}
function td(){const d=new Date();return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`}
function acol(n){let h=0;for(let i=0;i<n.length;i++)h=n.charCodeAt(i)+((h<<5)-h);return COLORS[Math.abs(h)%COLORS.length]}
function hap(){try{navigator.vibrate&&navigator.vibrate(10)}catch{}}

// Sync status
let syncStatus = { online: true, lastSync: null };
let isSyncing = false;

function updateSyncStatus(online) {
  syncStatus.online = online;
  syncStatus.lastSync = online ? new Date() : null;
  const statusEl = document.querySelector('.sync-status');
  if (statusEl) {
    statusEl.className = `sync-status show ${online ? 'online' : 'offline'}`;
    statusEl.textContent = online ? 'åœ¨çº¿' : 'ç¦»çº¿';
    setTimeout(() => {
      statusEl.classList.remove('show');
    }, 3000);
  }
}

// Check network status
window.addEventListener('online', () => updateSyncStatus(true));
window.addEventListener('offline', () => updateSyncStatus(false));

// Supabase functions
async function fetchFromSupabase() {
  if (!navigator.onLine) return null;

  try {
    const { data: students, error: studentsError } = await supabase
      .from('students')
      .select('*')
      .order('created_at', { ascending: true });

    if (studentsError) throw studentsError;

    const { data: lessonRecords, error: lessonError } = await supabase
      .from('lesson_records')
      .select('*')
      .order('lesson_date', { ascending: false });

    if (lessonError) throw lessonError;

    const { data: renewalRecords, error: renewalError } = await supabase
      .from('renewal_records')
      .select('*')
      .order('renewal_date', { ascending: false });

    if (renewalError) throw renewalError;

    // Process and combine data with parent_name compatibility
    const processedStudents = students.map(s => {
      const studentLessons = lessonRecords.filter(lr => lr.student_id === s.id);
      const studentRenewals = renewalRecords.filter(rr => rr.student_id === s.id);

      // Handle parent_name compatibility
      let parentName = s.parent_name;
      let notes = s.notes || '';
      if (!parentName && notes.includes('å®¶é•¿:')) {
        // Extract parent_name from notes if parent_name field doesn't exist
        const match = notes.match(/å®¶é•¿:([^|]+)/);
        if (match) {
          parentName = match[1].trim();
          // Remove parent info from notes for display
          notes = notes.replace(/\|?å®¶é•¿:[^|]+/, '').trim();
        }
      }

      return {
        ...s,
        parent_name: parentName,
        notes: notes,
        lessons: studentLessons.reduce((sum, lr) => sum + lr.lesson_count, 0),
        totalLessons: studentLessons.reduce((sum, lr) => sum + lr.lesson_count, 0),
        lastLesson: studentLessons[0]?.lesson_date || null,
        renewals: studentRenewals.map(rr => ({
          date: rr.renewal_date,
          amount: rr.amount,
          note: rr.note
        })),
        lastRenewDate: studentRenewals[0]?.renewal_date || null
      };
    });

    return {
      students: processedStudents,
      log: renewalRecords.map(rr => ({
        studentName: students.find(s => s.id === rr.student_id)?.name || '',
        studentId: rr.student_id,
        date: rr.renewal_date,
        amount: rr.amount,
        note: rr.note
      }))
    };
  } catch (error) {
    console.error('Error fetching from Supabase:', error);
    return null;
  }
}

async function saveToSupabase(data) {
  if (!navigator.onLine) return false;

  try {
    isSyncing = true;

    // Save students with parent_name compatibility handling
    for (const student of data.students) {
      // Prepare student data, handle parent_name compatibility
      const studentData = {
        id: student.id,
        name: student.name,
        contact: student.contact,
        total_lessons: student.total_lessons,
        completed_lessons: student.completed_lessons,
        notes: student.notes || '',
        created_at: student.created_at,
        updated_at: student.updated_at
      };

      // Try to include parent_name if it exists
      if (student.parent_name) {
        studentData.parent_name = student.parent_name;
      }

      const { error } = await supabase
        .from('students')
        .upsert(studentData, { onConflict: 'id' });

      // If parent_name column doesn't exist, store it in notes
      if (error && error.message.includes('parent_name')) {
        const fallbackData = { ...studentData };
        // Append parent_name to notes if not already there
        if (student.parent_name && !fallbackData.notes.includes(student.parent_name)) {
          fallbackData.notes = fallbackData.notes ? `${fallbackData.notes}|å®¶é•¿:${student.parent_name}` : `å®¶é•¿:${student.parent_name}`;
        }
        delete fallbackData.parent_name;

        const { error: fallbackError } = await supabase
          .from('students')
          .upsert(fallbackData, { onConflict: 'id' });

        if (fallbackError) throw fallbackError;
      } else if (error) {
        throw error;
      }
    }

    // Save lesson records
    for (const record of data.lessonRecords || []) {
      const { error } = await supabase
        .from('lesson_records')
        .upsert(record, { onConflict: 'id' });

      if (error) throw error;
    }

    // Save renewal records
    for (const record of data.renewalRecords || []) {
      const { error } = await supabase
        .from('renewal_records')
        .upsert(record, { onConflict: 'id' });

      if (error) throw error;
    }

    isSyncing = false;
    return true;
  } catch (error) {
    console.error('Error saving to Supabase:', error);
    isSyncing = false;
    return false;
  }
}

async function syncWithSupabase() {
  if (!navigator.onLine || isSyncing) return;

  try {
    isSyncing = true;
    updateSyncStatus(true);

    // Get fresh data from Supabase and use it directly (cloud as source of truth)
    const freshData = await fetchFromSupabase();

    if (freshData) {
      // Use cloud data directly, no merging - cloud is the source of truth
      const cloudData = {
        students: freshData.students || [],
        log: freshData.log || [],
        lessonRecords: [],
        renewalRecords: []
      };

      save(cloudData);
      S.data = cloudData;
      R();
    }

    isSyncing = false;
  } catch (error) {
    console.error('Sync error:', error);
    isSyncing = false;
    updateSyncStatus(false);
  }
}

// ===== State =====
let S={data:load(),tab:'all',exp:null,addOpen:false,confirm:null,search:'',settings:false};

// Load data and sync with Supabase
async function initializeApp() {
  // Try to load from Supabase first (cloud as source of truth)
  if (navigator.onLine) {
    const cloudData = await fetchFromSupabase();
    if (cloudData) {
      S.data = {
        students: cloudData.students || [],
        log: cloudData.log || [],
        lessonRecords: [],
        renewalRecords: []
      };
      save(S.data);
      R();
      return;
    }
  }

  // Fallback to localStorage if offline or fetch fails
  const localData = load();
  S.data = localData;
  R();

  // Try to sync after 1 second if we're using local data
  if (navigator.onLine) {
    setTimeout(syncWithSupabase, 1000);
  }
}

// Auto-sync every 30 seconds when online
setInterval(() => {
  if (navigator.onLine && !isSyncing) {
    syncWithSupabase();
  }
}, 30000);

// ===== Render =====
function R(){
  const{data,tab,exp,addOpen,confirm,search,settings}=S;
  const{students,log}=data;
  const nr=students.filter(s=>s.lessons>=10);
  const q=search.toLowerCase();
  let list=tab==='renew'?nr:students;
  if(q&&tab!=='log')list=list.filter(s=>s.name.includes(q)||(s.contact||'').includes(q)||(s.notes||'').includes(q)||(s.parent_name||'').includes(q));

  document.getElementById('app').innerHTML=`
    <div class="hdr">
      <h1>ğŸ“š è¯¾æ—¶ç®¡ç†</h1>
      <div class="hdr-stats">
        <div class="chip">å­¦ç”Ÿ <b>${students.length}</b></div>
        <div class="chip ${nr.length?'alert':''}">å¾…ç»­è´¹ <b>${nr.length}</b></div>
        <div class="chip">ç´¯è®¡ç»­è´¹ <b>${log.length}</b>æ¬¡</div>
      </div>
    </div>
    <div class="tabs">
      <div class="tab ${tab==='all'?'on':''}" onclick="T('all')">å…¨éƒ¨</div>
      <div class="tab ${tab==='renew'?'on':''}" onclick="T('renew')">å¾…ç»­è´¹${nr.length?`<span class="bdg">${nr.length}</span>`:''}</div>
      <div class="tab ${tab==='log'?'on':''}" onclick="T('log')">ç»­è´¹è®°å½•</div>
    </div>
    ${tab!=='log'?`<div class="sbar"><i>ğŸ”</i><input placeholder="æœç´¢å­¦ç”Ÿ / ç§‘ç›® / å®¶é•¿â€¦" value="${search}" oninput="S.search=this.value;R()"></div>`:''}
    ${tab==='log'?rLog(log):rList(list)}
    <button class="fab" onclick="oAdd()" aria-label="æ·»åŠ å­¦ç”Ÿ">ï¼‹</button>
    <button class="gear" onclick="oSet()" aria-label="è®¾ç½®">âš™</button>
    ${addOpen?rAdd():''}${confirm?rCfm():''}${settings?rSet():''}
  `;
}

function rList(list){
  if(!list.length)return `<div class="empty"><div class="empty-ico">${S.tab==='renew'?'ğŸ‰':'ğŸ“‹'}</div><div class="empty-txt">${S.tab==='renew'?'æš‚æ— å¾…ç»­è´¹å­¦ç”Ÿ':'ç‚¹å‡»å³ä¸‹è§’ ï¼‹ æ·»åŠ å­¦ç”Ÿ'}</div></div>`;
  return list.map(s=>{
    const p=Math.min(s.lessons/10,1)*100,nr=s.lessons>=10,ne=s.lessons>=8,op=S.exp===s.id;
    const bc=nr?'var(--warn)':ne?'#ffb340':'var(--accent)',cc=nr?'var(--warn)':'var(--accent)';
    return `
    <div class="card ${nr?'warn':''}" onclick="X('${s.id}')">
      <div class="card-row">
        <div class="card-left">
          <div class="av" style="background:${acol(s.name)}">${s.name[0]}</div>
          <div style="min-width:0">
            <div><span class="nm">${s.name}</span>${s.notes?`<span class="subj">${s.notes}</span>`:''}</div>
            ${nr?'<span class="rtag pulse">ğŸ”” éœ€ç»­è´¹</span>':''}
            ${s.parent_name?`<div class="ct-info"><span>ğŸ‘¤${s.parent_name}</span>${s.contact?`<span>ğŸ“±${s.contact}</span>`:''}</div>`:''}
            ${!s.parent_name&&s.contact?`<div class="ct-info"><span>ğŸ“±${s.contact}</span></div>`:''}
          </div>
        </div>
        <div class="cnt"><div class="n" style="color:${cc}">${s.lessons}</div><div class="l">/10</div></div>
      </div>
      <div class="prog"><div class="prog-fill" style="width:${p}%;background:${bc}"></div></div>
      ${op?`
        <div class="acts" onclick="event.stopPropagation()">
          <button class="btn btn-p" onclick="aL('${s.id}')">ï¼‹ è®°ä¸€æ¬¡è¯¾</button>
          <button class="btn btn-g btn-sm" onclick="uL('${s.id}')">â†© æ’¤é”€</button>
          ${nr?`<button class="btn btn-w" onclick="sCfm('renew','${s.id}')">ğŸ’° ç»­è´¹</button>`:''}
          <button class="btn btn-d btn-sm ml-auto" onclick="sCfm('del','${s.id}')">åˆ é™¤</button>
        </div>
        ${(S.data.log||[]).filter(l=>l.studentId===s.id).length?`
          <div class="rhist"><strong>ç»­è´¹è®°å½•</strong><div>${(S.data.log||[]).filter(l=>l.studentId===s.id).map((r,i)=>`<span class="ritem">ç¬¬${i+1}æ¬¡ ${r.date}${r.amount?' Â¥'+Number(r.amount).toLocaleString():''}</span>`).join('')}</div></div>
        `:''}
      `:''}
    </div>`;
  }).join('');
}

function rLog(log){
  if(!log.length)return '<div class="empty"><div class="empty-ico">ğŸ“</div><div class="empty-txt">æš‚æ— ç»­è´¹è®°å½•</div></div>';
  const sorted=[...log].sort((a,b)=>b.date.localeCompare(a.date));
  let tot=0;sorted.forEach(r=>{if(r.amount)tot+=Number(r.amount)});
  return `
    ${tot?`<div class="log-total"><div class="lbl">ç´¯è®¡æ”¶æ¬¾</div><div class="amt">Â¥${tot.toLocaleString()}</div></div>`:''}
    ${sorted.map(r=>`
      <div class="log-card">
        <div class="log-top"><span class="log-nm">${r.studentName}</span><span class="log-dt">${r.date}</span></div>
        <div class="log-det">${r.amount?'Â¥'+Number(r.amount).toLocaleString():''}${r.note?' Â· '+r.note:''}</div>
      </div>
    `).join('')}`;
}

function rAdd(){return `
  <div class="ov" onclick="cAdd()"><div class="modal" onclick="event.stopPropagation()">
    <button class="mx" onclick="cAdd()">âœ•</button>
    <h2>æ·»åŠ å­¦ç”Ÿ</h2>
    <div class="fg"><label class="fl">å­¦ç”Ÿå§“å *</label><input class="fi" id="i-nm" placeholder="è¾“å…¥å§“å"></div>
    <div class="fg"><label class="fl">ç§‘ç›®</label><input class="fi" id="i-sj" placeholder="å¦‚ï¼šæ•°å­¦ã€è‹±è¯­"></div>
    <div class="fr">
      <div class="fg"><label class="fl">å®¶é•¿å§“å</label><input class="fi" id="i-pn" placeholder="é€‰å¡«"></div>
      <div class="fg"><label class="fl">å®¶é•¿è”ç³»æ–¹å¼</label><input class="fi" id="i-pc" placeholder="æ‰‹æœºå·/å¾®ä¿¡å·"></div>
    </div>
    <div class="fg"><label class="fl">å·²ä¸Šè¯¾æ—¶</label><input class="fi" id="i-ls" type="number" placeholder="0" inputmode="numeric" step="0.5"></div>
    <button class="fs" onclick="subAdd()">ç¡®è®¤æ·»åŠ </button>
  </div></div>`}

function rCfm(){
  const c=S.confirm,isR=c.type==='renew';
  return `
  <div class="cdlg" onclick="cCfm()"><div class="cbox" onclick="event.stopPropagation()">
    <h3>${isR?'ç¡®è®¤ç»­è´¹':'ç¡®è®¤åˆ é™¤'}</h3>
    <p>${isR?'è¯¾æ—¶å½’é›¶å¹¶è®°å½•ç»­è´¹ä¿¡æ¯':'æ­¤æ“ä½œä¸å¯æ’¤é”€'}</p>
    ${isR?`
      <div class="fg" style="text-align:left"><label class="fl">ç»­è´¹é‡‘é¢ï¼ˆå…ƒï¼‰</label><input class="fi" id="r-amt" type="number" placeholder="é€‰å¡«" inputmode="decimal" step="0.01"></div>
      <div class="fg" style="text-align:left"><label class="fl">ç»­è´¹æ—¥æœŸ</label><input class="fi" id="r-dt" value="${td()}"></div>
      <div class="fg" style="text-align:left"><label class="fl">å¤‡æ³¨</label><input class="fi" id="r-nt" placeholder="å¦‚ï¼šå¾®ä¿¡è½¬è´¦"></div>
    `:''}
    <div class="cbtns">
      <button class="btn btn-g" onclick="cCfm()">å–æ¶ˆ</button>
      <button class="btn ${isR?'btn-w':'btn-p'}" style="${isR?'':'background:var(--danger)'}" onclick="doCfm()">ç¡®è®¤</button>
    </div>
  </div></div>`}

function rSet(){return `
  <div class="ov" onclick="cSet()"><div class="modal" onclick="event.stopPropagation()">
    <button class="mx" onclick="cSet()">âœ•</button>
    <h2>âš™ è®¾ç½®</h2>
    <div class="settings-list">
      <div class="settings-item" onclick="syncNow()">
        <div><div class="si-label">ğŸ”„ åŒæ­¥æ•°æ®</div><div class="si-hint">ç«‹å³åŒæ­¥åˆ°äº‘ç«¯</div></div>
        <span class="si-arrow">â€º</span>
      </div>
      <div class="settings-item" onclick="expData()">
        <div><div class="si-label">ğŸ“¤ å¯¼å‡ºæ•°æ®</div><div class="si-hint">å¤‡ä»½æ‰€æœ‰å­¦ç”Ÿå’Œç»­è´¹è®°å½•</div></div>
        <span class="si-arrow">â€º</span>
      </div>
      <div class="settings-item" onclick="document.getElementById('imp-file').click()">
        <div><div class="si-label">ğŸ“¥ å¯¼å…¥æ•°æ®</div><div class="si-hint">ä»å¤‡ä»½æ–‡ä»¶æ¢å¤æ•°æ®</div></div>
        <span class="si-arrow">â€º</span>
      </div>
      <input type="file" id="imp-file" accept=".json" style="display:none" onchange="impData(event)">
      <div class="settings-item" onclick="clrData()">
        <div><div class="si-label" style="color:var(--danger)">ğŸ—‘ æ¸…ç©ºæ‰€æœ‰æ•°æ®</div><div class="si-hint">åˆ é™¤å…¨éƒ¨å­¦ç”Ÿå’Œç»­è´¹è®°å½•</div></div>
        <span class="si-arrow">â€º</span>
      </div>
    </div>
    <div style="margin-top:20px;text-align:center;font-size:11px;color:var(--text-dim)">
      è¯¾æ—¶ç®¡ç† v2.0 Â· æ•°æ®å·²æ¥å…¥ Supabase äº‘å­˜å‚¨<br>
      æœ¬åœ°æ•°æ®ä½œä¸ºç¦»çº¿ç¼“å­˜ ğŸ“¦
    </div>
  </div></div>`}

// ===== Actions =====
function T(t){hap();S.tab=t;S.exp=null;R()}
function X(id){hap();S.exp=S.exp===id?null:id;R()}
function oAdd(){hap();S.addOpen=true;R();setTimeout(()=>{const e=document.getElementById('i-nm');e&&e.focus()},120)}
function cAdd(){S.addOpen=false;R()}
function sCfm(t,id){hap();S.confirm={type:t,studentId:id};R()}
function cCfm(){S.confirm=null;R()}
function oSet(){hap();S.settings=true;R()}
function cSet(){S.settings=false;R()}

async function aL(id){
  hap();
  const s=S.data.students.find(x=>x.id===id);if(!s)return;

  // Create lesson record
  const lessonRecord = {
    id: generateId(),
    student_id: id,
    lesson_count: 1,
    lesson_date: td(),
    note: ''
  };

  // Update student
  s.lessons++;s.totalLessons=(s.totalLessons||0)+1;s.lastLesson=td();

  // Add to lesson records
  S.data.lessonRecords = S.data.lessonRecords || [];
  S.data.lessonRecords.push(lessonRecord);

  save(S.data);
  R();

  // Sync to Supabase
  if (navigator.onLine) {
    try {
      const { error } = await supabase
        .from('lesson_records')
        .insert([lessonRecord]);

      if (error) throw error;
    } catch (err) {
      console.error('Failed to sync lesson:', err);
    }
  }

  if(s.lessons===10){
    setTimeout(()=>{
      alert(`ğŸ”” ${s.name} å·²æ»¡10æ¬¡è¯¾ï¼\nè¯·é€šçŸ¥${s.parent_name||'å®¶é•¿'}ç»­è´¹ã€‚${s.contact?'\nğŸ“± '+s.contact:''}`);
    },180);
  }
}
async function uL(id){
  hap();const s=S.data.students.find(x=>x.id===id);
  if(!s||s.lessons<=0)return;

  // Find last lesson record
  const lastLesson = (S.data.lessonRecords || [])
    .filter(lr => lr.student_id === id)
    .sort((a, b) => b.lesson_date.localeCompare(a.lesson_date))[0];

  if (lastLesson) {
    // Update lesson count
    s.lessons--;s.totalLessons=Math.max(0,(s.totalLessons||0)-1);

    // Remove lesson record
    S.data.lessonRecords = (S.data.lessonRecords || [])
      .filter(lr => lr.id !== lastLesson.id);

    save(S.data);
    R();

    // Sync to Supabase
    if (navigator.onLine) {
      try {
        const { error } = await supabase
          .from('lesson_records')
          .delete()
          .eq('id', lastLesson.id);

        if (error) throw error;
      } catch (err) {
        console.error('Failed to sync lesson deletion:', err);
      }
    }
  }
}

async function subAdd(){
  const nm=document.getElementById('i-nm').value.trim();
  if(!nm){alert('è¯·è¾“å…¥å­¦ç”Ÿå§“å');return}
  const ls=parseFloat(document.getElementById('i-ls').value)||0;
  const subject = document.getElementById('i-sj').value.trim();
  const parentName = document.getElementById('i-pn').value.trim();
  const parentContact = document.getElementById('i-pc').value.trim();

  // Create student
  const student = {
    id: generateId(),
    name: nm,
    contact: parentContact,
    parent_name: parentName,
    total_lessons: ls,
    completed_lessons: ls,
    notes: subject,
    created_at: new Date().toISOString(),
    updated_at: new Date().toISOString()
  };

  S.data.students.push(student);
  save(S.data);
  hap();
  S.addOpen = false;
  R();

  // Sync to Supabase with parent_name compatibility
  if (navigator.onLine) {
    try {
      const { error } = await supabase
        .from('students')
        .insert([student]);

      // If parent_name column doesn't exist, fallback to storing in notes
      if (error && error.message.includes('parent_name')) {
        const fallbackStudent = { ...student };
        if (parentName) {
          fallbackStudent.notes = subject ? `${subject}|å®¶é•¿:${parentName}` : `å®¶é•¿:${parentName}`;
        }
        delete fallbackStudent.parent_name;

        const { error: fallbackError } = await supabase
          .from('students')
          .insert([fallbackStudent]);

        if (fallbackError) throw fallbackError;

        // Update local student to match fallback format
        student.parent_name = undefined;
        student.notes = fallbackStudent.notes;
        save(S.data);
      } else if (error) {
        throw error;
      }
    } catch (err) {
      console.error('Failed to sync student:', err);
    }
  }
}

async function doCfm(){
  const{type,studentId}=S.confirm;
  if(type==='renew'){
    const s=S.data.students.find(x=>x.id===studentId);if(!s)return;
    const amt=parseFloat(document.getElementById('r-amt')?.value.trim())||null;
    const dt=document.getElementById('r-dt')?.value.trim()||td();
    const nt=document.getElementById('r-nt')?.value.trim()||'';

    // Create renewal record
    const renewalRecord = {
      id: generateId(),
      student_id: studentId,
      lessons_added: s.lessons,
      amount: amt,
      renewal_date: dt,
      note: nt
    };

    // Update student
    s.lessons = 0;
    s.total_lessons = s.completed_lessons;
    s.lastRenewDate = dt;

    // Add to records
    S.data.renewalRecords = S.data.renewalRecords || [];
    S.data.renewalRecords.push(renewalRecord);

    S.data.log = S.data.log || [];
    S.data.log.push({
      date: dt,
      amount: amt,
      note: nt,
      studentName: s.name,
      studentId: s.id
    });

    // Update student in Supabase
    if (navigator.onLine) {
      try {
        const { error: studentError } = await supabase
          .from('students')
          .update({
            total_lessons: s.total_lessons,
            completed_lessons: s.completed_lessons,
            updated_at: new Date().toISOString()
          })
          .eq('id', studentId);

        if (studentError) throw studentError;

        // Insert renewal record
        const { error: renewalError } = await supabase
          .from('renewal_records')
          .insert([renewalRecord]);

        if (renewalError) throw renewalError;
      } catch (err) {
        console.error('Failed to sync renewal:', err);
      }
    }
  }else{
    // Delete student from local storage immediately
    S.data.students = S.data.students.filter(x=>x.id!==studentId);
    S.data.lessonRecords = (S.data.lessonRecords || []).filter(lr => lr.student_id !== studentId);
    S.data.renewalRecords = (S.data.renewalRecords || []).filter(rr => rr.student_id !== studentId);
    S.data.log = (S.data.log || []).filter(l => l.studentId !== studentId);
    if(S.exp===studentId)S.exp=null;

    // Save to localStorage immediately
    save(S.data);
    R();

    // Delete from Supabase (fire and forget, but with proper error handling)
    if (navigator.onLine) {
      try {
        // Delete related records first (cascade)
        const { error: lessonError } = await supabase
          .from('lesson_records')
          .delete()
          .eq('student_id', studentId);

        if (lessonError) console.error('Failed to delete lesson records:', lessonError);

        const { error: renewalError } = await supabase
          .from('renewal_records')
          .delete()
          .eq('student_id', studentId);

        if (renewalError) console.error('Failed to delete renewal records:', renewalError);

        // Delete student
        const { error: studentError } = await supabase
          .from('students')
          .delete()
          .eq('id', studentId);

        if (studentError) console.error('Failed to delete student:', studentError);

        // After successful deletion, force sync to ensure cache is cleared
        if (!lessonError && !renewalError && !studentError) {
          await syncWithSupabase();
        }
      } catch (err) {
        console.error('Failed to delete student from Supabase:', err);
      }
    }
  }
  hap();S.confirm=null;
}

// ===== Data Management =====
function expData(){
  const str=JSON.stringify(S.data,null,2);
  const blob=new Blob([str],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download=`è¯¾æ—¶ç®¡ç†_å¤‡ä»½_${td().replace(/\//g,'-')}.json`;
  a.click();URL.revokeObjectURL(url);
  alert('âœ… æ•°æ®å·²å¯¼å‡ºä¸º JSON æ–‡ä»¶');
}
function impData(e){
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=function(ev){
    try{
      const d=JSON.parse(ev.target.result);
      if(d.students){
        if(confirm(`å°†å¯¼å…¥ ${d.students.length} åå­¦ç”Ÿã€${(d.log||[]).length} æ¡ç»­è´¹è®°å½•ã€‚\nâš ï¸ è¿™ä¼šè¦†ç›–å½“å‰æ•°æ®ï¼Œç¡®è®¤ï¼Ÿ`)){
          S.data=d;save(S.data);S.settings=false;R();
          alert('âœ… å¯¼å…¥æˆåŠŸï¼');
        }
      }else{alert('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®')}
    }catch{alert('æ–‡ä»¶è§£æå¤±è´¥')}
  };
  reader.readAsText(file);
  e.target.value='';
}
function syncNow(){
  if (navigator.onLine) {
    syncWithSupabase();
    alert('ğŸ”„ æ­£åœ¨åŒæ­¥æ•°æ®...');
  } else {
    alert('âŒ å½“å‰å¤„äºç¦»çº¿çŠ¶æ€ï¼Œè¯·è¿æ¥ç½‘ç»œåé‡è¯•');
  }
}
function clrData(){
  if(confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ\nå»ºè®®å…ˆå¯¼å‡ºå¤‡ä»½ï¼')){
    if(confirm('å†æ¬¡ç¡®è®¤ï¼šçœŸçš„è¦åˆ é™¤å…¨éƒ¨å­¦ç”Ÿå’Œç»­è´¹è®°å½•ï¼Ÿ')){
      S.data={students:[],log:[],lessonRecords:[],renewalRecords:[]};save(S.data);
      S.settings=false;R();
      // Clear Supabase data
      if (navigator.onLine) {
        supabase.from('students').delete().neq('id', 'non-existent');
        supabase.from('lesson_records').delete().neq('id', 'non-existent');
        supabase.from('renewal_records').delete().neq('id', 'non-existent');
      }
    }
  }
}

// ===== Init =====
initializeApp();

// ===== Service Worker =====
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('./sw.js')
      .then(r=>console.log('SW registered'))
      .catch(e=>console.log('SW failed:',e));
  });
}
</script>
</body>
</html>
